<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name}">Product Detail</title>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link rel="stylesheet" href="/css/product-detail.css">
    <link rel="stylesheet" href="/css/nav.css">
</head>
<body>

<header>
    <div class="navbar">
        <div class="logo">
            <a href="/home"><img src="/images/logo.png" alt="Modaz Logo"></a>
        </div>
        <ul class="nav-links">
            <li><a href="/home">HOME</a></li>
            <li><a href="/shop">SHOP</a></li>
            <li class="dropdown">
                <a href="#">CONTACT</a>
                <ul class="dropdown-content">
                    <li><a href="/contact/notice">공지사항</a></li>
                    <li><a href="/about">자주묻는질문</a></li>
                    <li><a href="/inquiry">1:1문의</a></li>
                </ul>
            </li>
        </ul>
        <div class="icons">
            <a href="#" class="icon-container">
                <img src="/images/search.svg" alt="Search Icon" class="icon">
            </a>
            <th:block th:if="${session.loginMember == null}">
                <a href="/login" class="icon-container">
                    <img src="/images/profile.svg" alt="Login Icon" class="icon">
                </a>
            </th:block>
            <th:block th:if="${session.loginMember != null}">
                <a href="/mypage" class="icon-container">
                    <img src="/images/profile.svg" alt="Profile Icon" class="icon">
                </a>
                <a href="/logout" class="icon-container">로그아웃</a>
            </th:block>
            <a href="/cart" class="icon-container">
                <img src="/images/cart.svg" alt="Cart Icon" class="icon">
            </a>
        </div>
    </div>
</header>

<section class="product-detail">
    <div class="product-image">
        <!-- 이미지 경로 수정 -->
        <img th:src="@{'/product_IMG_/' + ${product.imageName}}" alt="Product Image">
    </div>
    <div class="product-info">
        <h1 class="product-title" th:text="${product.name}">Product Name</h1>
        <p th:text="${product.description}">Product Description</p>
        <p class="price">
            <span class="old-price" th:if="${product.oldPrice != null}" th:text="'$' + ${product.oldPrice}">Old Price</span>
            <span th:text="'$' + ${product.price}">Price</span>
        </p>

        <!-- 사이즈 선택 부분 수정 -->
        <div class="sizes">
            <strong>Size:</strong>
            <div class="size-options">
                <label class="size-label">
                    <input type="radio" name="size" value="S">
                    <span class="size-text">S</span>
                </label>
                <label class="size-label">
                    <input type="radio" name="size" value="M">
                    <span class="size-text">M</span>
                </label>
                <label class="size-label">
                    <input type="radio" name="size" value="L">
                    <span class="size-text">L</span>
                </label>
                <label class="size-label">
                    <input type="radio" name="size" value="XL">
                    <span class="size-text">XL</span>
                </label>
                <label class="size-label">
                    <input type="radio" name="size" value="XXL">
                    <span class="size-text">XXL</span>
                </label>
            </div>
        </div>

        <!-- 색상 선택 섹션 -->
        <div class="product-options">
            <div class="color-select">
                <label>COLOR</label>
                <div class="color-dropdown">
                    <button type="button" class="color-select-btn">
                        <span class="selected-color"></span>
                        <span class="color-text">색상 선택</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <ul class="color-options-dropdown">
                        <li class="color-option" data-color="white">
                            <span class="color-circle white"></span>
                            <span class="color-name">화이트</span>
                        </li>
                        <li class="color-option" data-color="olive">
                            <span class="color-circle olive"></span>
                            <span class="color-name">올리브</span>
                        </li>
                        <li class="color-option" data-color="brown">
                            <span class="color-circle brown"></span>
                            <span class="color-name">브라운</span>
                        </li>
                        <li class="color-option" data-color="navy">
                            <span class="color-circle navy"></span>
                            <span class="color-name">네이비</span>
                        </li>
                        <li class="color-option" data-color="gray">
                            <span class="color-circle gray"></span>
                            <span class="color-name">그레이</span>
                        </li>
                        <li class="color-option" data-color="black">
                            <span class="color-circle black"></span>
                            <span class="color-name">블랙</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- features 부분은 쉼표를 만나면 줄 변경 하도록  특별 요청 -->
        <ul class="features">
            <th:block th:if="${product.feature != null}">
                <th:block th:each="item : ${#strings.arraySplit(product.feature, ',')}">
                    <li th:text="${item}">Feature Item</li>
                </th:block>
            </th:block>
        </ul>


        <!-- 수량 및 버튼 한 줄 배치 -->
        <div class="quantity-and-buttons">
            <div class="quantity-control">
                <input type="number" id="quantity" name="quantity" value="1" min="1">
            </div>
            <button class="add-to-cart">ADD TO CART</button>
            <button class="heart-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>
            <button class="view-3d-button">
                <span>FITTING</span>
            </button>
            <button class="view-3D-button">
                <span>3D VIEW</span>
            </button>
        </div>
    </div>
</section>

<!-- 상품 ID를 hidden input으로 추가 -->
<input type="hidden" id="productId" th:value="${product.id}">

<!-- 기존 스크립트 태그를 수정 -->
<script src="/static/scripts/productdetail.js"></script>

<!-- 페이지 하단에 다음 스크립트 추가 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 버튼과 드롭다운 요소 선택
    const btn = document.querySelector('.color-select-btn');
    const dropdown = document.querySelector('.color-options-dropdown');
    const selectedColorCircle = document.querySelector('.selected-color');
    const colorText = document.querySelector('.color-text');

    // 버튼 클릭 이벤트
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // 드롭다운 토글
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            dropdown.style.display = 'block';
        }
    });

    // 색상 옵션 선택 이벤트
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            const color = this.getAttribute('data-color');
            const colorName = this.querySelector('.color-name').textContent;
            const colorCircle = this.querySelector('.color-circle');
            
            // 선택된 색상 원 업데이트 - 실제 색상값 사용
            selectedColorCircle.style.backgroundColor = getComputedStyle(colorCircle).backgroundColor;
            // 선택된 색상 텍스트 업데이트
            colorText.textContent = colorName;
            
            // hidden input 업데이트
            let colorInput = document.querySelector('input[name="color"]');
            if (!colorInput) {
                colorInput = document.createElement('input');
                colorInput.type = 'hidden';
                colorInput.name = 'color';
                document.querySelector('.color-dropdown').appendChild(colorInput);
            }
            colorInput.value = color;
            
            // 드롭다운 닫기
            dropdown.style.display = 'none';
        });
    });

    // 드롭다운 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
        if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // 장바구니 추가 버튼 클릭 이벤트
    const addToCartButton = document.querySelector('.add-to-cart');
    
    addToCartButton.addEventListener('click', function() {
        const productId = document.getElementById('productId').value;
        const quantity = document.getElementById('quantity').value;
        const selectedSize = document.querySelector('input[name="size"]:checked')?.value;
        // 색상은 hidden input에서 가져오기
        const selectedColor = document.querySelector('input[name="color"]')?.value;

        console.log('선택된 사이즈:', selectedSize); // 디버깅용
        console.log('선택된 색상:', selectedColor); // 디버깅용

        // 필수 선택 옵션 확인
        if (!selectedSize) {
            alert('사이즈를 선택해주세요.');
            return;
        }
        
        if (!selectedColor) {
            alert('색상을 선택해주세요.');
            return;
        }

        // 장바구니 추가 요청
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId: productId,
                quantity: parseInt(quantity),
                size: selectedSize,
                color: selectedColor
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            if (confirm('상품이 장바구니에 추가되었습니다.\n장바구니로 이동하시겠습니까?')) {
                window.location.href = '/cart';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message.includes('401')) {
                if (confirm('로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?')) {
                    window.location.href = '/login';
                }
            } else {
                alert('장바구니 추가에 실패했습니다.');
            }
        });
    });
});
</script>
</body>
</html>